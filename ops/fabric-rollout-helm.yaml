# Values snippet for deploying the Fabric consensus peer within the federation chart.
fabric:
  enabled: true
  image:
    repository: hyperledger/fabric-peer
    tag: "2.5"
    pullPolicy: IfNotPresent
  persistence:
    consensusState:
      enabled: true
      storageClass: fast-replicated
      accessMode: ReadWriteOnce
      size: 20Gi
      mountPath: /var/hyperledger/production
  env:
    FABRIC_CFG_PATH: /etc/hyperledger/fabric
    FABRIC_LOGGING_SPEC: INFO
    FABRIC_CONSENSUS_STATE_DIR: /var/hyperledger/production/consensus
    CORE_LEDGER_STATE_STATEDATABASE: goleveldb
    CORE_LEDGER_STATE_TOTALCACHESIZE: "256"
    CORE_OPERATIONS_LISTENADDRESS: 0.0.0.0:9443
    CORE_METRICS_PROVIDER: prometheus
    CORE_METRICS_PROMETHEUS_HANDLERPATH: /metrics
  service:
    type: ClusterIP
    ports:
      - name: peer
        port: 7051
        targetPort: 7051
      - name: metrics
        port: 9443
        targetPort: 9443
  podAnnotations:
    prometheus.io/scrape: "true"
    prometheus.io/path: /metrics
    prometheus.io/port: "9443"
  logShipping:
    enabled: true
    format: json
    sink: temporal-ledger
    extraFields:
      subsystem: fabric
      federation: continuum
negotiationRelay:
  enabled: true
  image:
    repository: echo/negotiation-gateway
    tag: "0.4.1"
    pullPolicy: IfNotPresent
  env:
    NEGOTIATION_EVENT_TOPIC: negotiation.events
    NEGOTIATION_DEFAULT_TIMEOUT_SECONDS: "45"
    NEGOTIATION_CALLBACK_BASE_URL: https://negotiation-gateway.svc.cluster.local/api
    NEGOTIATION_AUDIT_BUCKET: gs://echo-negotiation-audit
  service:
    type: ClusterIP
    ports:
      - name: http
        port: 8080
        targetPort: 8080
  rollout:
    staging:
      steps:
        - "helm upgrade --install negotiation ops/federation-chart --set negotiationRelay.enabled=true --set negotiationRelay.env.NEGOTIATION_CALLBACK_BASE_URL=https://negotiation-gateway.staging/api"
        - "Verify negotiation.events topic ingestion via staging telemetry dashboard"
        - "Run synthetic counterparty workflow to confirm recovery hooks"
    production:
      steps:
        - "Promote negotiation-gateway:0.4.1 image after staging burn-in"
        - "Apply Helm release with production secrets and audit bucket credentials"
        - "Enable audit streaming toggle once SLO dashboards show green for 30 minutes"

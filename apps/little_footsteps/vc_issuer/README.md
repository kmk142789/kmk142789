# Little Footsteps VC Issuer

Express-based issuer that signs childcare vouchers, donation receipts, and other Little Footsteps credentials.

## Features

- **Postgres-backed ledger** – automatic schema migrations for `ledger_events` and `issued_credentials`.
- **Ed25519 signing** – loads the PEM private key generated by `scripts/generate_ed25519_keypair.py` and signs VCs using EdDSA JWS.
- **JSON telemetry** – structured logs for each HTTP request and error, ready for Prometheus, Grafana Loki, or any log pipeline.
- **Trust registry enforcement** – refuses to issue credentials that are not listed in `docs/little_footsteps/trust_registry.json`.
- **Schema validation** – `DonationReceiptCredential` and `ImpactPayoutCredential` subjects are validated against published JSON Schemas before signing.

## Running locally

```bash
cp apps/little_footsteps/vc_issuer/.env.example apps/little_footsteps/vc_issuer/.env
# Edit DATABASE_URL and VC_ISSUER_DID as needed
node apps/little_footsteps/vc_issuer/server.js
```

### Environment variables

| Variable | Description | Default |
| --- | --- | --- |
| `DATABASE_URL` | Postgres connection string for the ledger tables. | _required_ |
| `VC_ISSUER_DID` | DID used as the credential issuer. | _required_ |
| `VC_PRIVATE_KEY_PATH` | Path to the Ed25519 private key (PKCS8 PEM). | `state/little_footsteps/keys/issuer-ed25519-private.key` |
| `CORS_ALLOW_ORIGINS` | Optional comma-separated list of dashboard origins. | _unset (allow all)_ |
| `DONATION_RECEIPTS_LOG_PATH` | JSONL log of receipt payloads. | `state/little_footsteps/donation_receipts.jsonl` |
| `DONATION_TELEMETRY_LOG_PATH` | JSONL log powering the dashboard stream. | `state/little_footsteps/dashboard/donations.jsonl` |
| `TRUST_REGISTRY_PATH` | Path to the trust registry JSON file. | `docs/little_footsteps/trust_registry.json` |
| `CREDENTIAL_SCHEMA_DIR` | Directory containing credential schemas. | `docs/little_footsteps/credentials/schemas` |
| `PORT` | HTTP port for the issuer. | `4000` |

### Key endpoints

| Method | Path | Description |
| ------ | ---- | ----------- |
| `GET` | `/healthz` | Service status and DID identifier |
| `GET` | `/stream` | Server-sent events stream that pushes new ledger entries and refreshed totals to the dashboard |
| `POST` | `/donations/intake` | Record a BTC/ETH/Stripe/PayPal donation, emit a VC, and log telemetry |
| `POST` | `/payouts/create` | Record an impact payout, issue an `ImpactPayoutCredential`, and append to the ledger + telemetry |
| `POST` | `/ledger/events` | Append a donation, credit, or payout to the transparency ledger |
| `GET` | `/ledger/events` | Retrieve the most recent ledger events |
| `GET` | `/metrics/totals` | Aggregate inflow/outflow totals for the current day |
| `POST` | `/issue/childcare-voucher` | Issue a signed childcare voucher VC and optionally log a ledger event |

All endpoints emit structured logs such as:

```json
{"timestamp":"2025-05-11T04:00:00.123Z","level":"info","event":"http_request","method":"POST","path":"/issue/childcare-voucher","status":201,"duration_ms":42.1,"request_id":"1b37e1c4-..."}
```

Pipe these logs into Promtail, Vector, or another collector to expose them in Grafana or alerting systems.

### Donation intake receipts

The donation intake endpoint automatically:

- Appends receipt records to `state/little_footsteps/donation_receipts.jsonl` (override with `DONATION_RECEIPTS_LOG_PATH`).
- Streams telemetry-friendly events to `state/little_footsteps/dashboard/donations.jsonl` (override with `DONATION_TELEMETRY_LOG_PATH`).
- Issues a `DonationReceiptCredential` verifiable credential signed with the Ed25519 key configured for the issuer.

Each request can provide either `amount` (decimal string, e.g. `"0.05"`) or `amount_minor` (base units such as satoshis or wei). Supply `method` with one of `btc`, `eth`, `stripe`, or `paypal`, alongside any transaction metadata you want persisted to the ledger.
